# 内存带宽测试程序

一个简单的内存带宽测试工具，支持多种内存操作模式的性能测试。

## 编译

```bash
make
```

## 使用方法

```bash
# 基本测试
./bandwidth_test

# 详细输出
./bandwidth_test -v

# 多线程测试
./bandwidth_test -t 4 -a

# 查看帮助
./bandwidth_test -h
```

## 测试模式

- 读取带宽测试
- 写入带宽测试  
- 内存复制带宽测试
- 缩放操作带宽测试
- 加法操作带宽测试
- 三元组操作带宽测试

## 选项说明

- `-s <size>`: 缓冲区大小（MB）
- `-i <iterations>`: 迭代次数
- `-t <threads>`: 线程数
- `-a`: 启用线程亲和性
- `-v`: 详细输出
- `-h`: 显示帮助

## 功能特性

- **多种测试模式**：
  - 读取带宽测试
  - 写入带宽测试
  - 内存复制带宽测试
  - 缩放操作带宽测试 (dst = a * src)
  - 加法操作带宽测试 (dst = src1 + src2)
  - 三元组操作带宽测试 (dst = a * src1 + src2)

- **多线程支持**：支持多线程并发测试
- **线程亲和性**：可以绑定线程到特定 CPU 核心
- **可配置参数**：缓冲区大小、迭代次数等
- **详细输出**：支持详细模式显示每次测试的结果

## 测试原理

### 缓存行对齐

程序使用 64 字节的缓存行大小进行内存访问，避免缓存未命中的影响：

```c
#define CACHE_LINE_SIZE 64
```

### 避免编译器优化

使用 `volatile` 关键字和条件语句来防止编译器优化掉测试代码：

```c
volatile char sink = 0;
// ...
if (sink == 0) printf(" ");
```

### 预热缓存

在正式测试前先进行一次内存访问来预热缓存：

```c
// 预热缓存
for (size_t i = 0; i < size; i += CACHE_LINE_SIZE) {
    sink += buffer[i];
}
```

## 性能分析

### 典型结果

在现代系统上，典型的带宽结果可能如下：

- **读取带宽**: 20-50 GB/s
- **写入带宽**: 15-40 GB/s
- **复制带宽**: 15-35 GB/s
- **计算带宽**: 10-25 GB/s

### 影响因素

1. **内存类型**: DDR4/DDR5 等
2. **内存通道数**: 单通道/双通道/四通道
3. **CPU 架构**: 内存控制器性能
4. **系统负载**: 其他进程的内存使用
5. **NUMA 配置**: 多处理器系统的内存访问模式

## 使用 Makefile

```bash
# 编译
make

# 运行基本测试
make test

# 运行多线程测试
make test-mt

# 查看所有可用目标
make help
```

## 注意事项

1. **权限要求**: 程序需要足够的内存来分配测试缓冲区
2. **系统负载**: 测试时尽量关闭其他程序以获得准确结果
3. **CPU 频率**: 确保 CPU 运行在正常频率下
4. **内存大小**: 确保系统有足够的内存进行测试

## 故障排除

### 常见问题

1. **内存分配失败**: 减少缓冲区大小或关闭其他程序
2. **线程创建失败**: 检查系统资源限制
3. **亲和性设置失败**: 检查 CPU 核心数量

### 调试

使用调试版本进行编译：

```bash
make debug
gdb ./bandwidth_test
```

## 扩展

可以基于此程序进行以下扩展：

1. **更多测试模式**: 添加其他内存操作模式
2. **NUMA 感知**: 支持 NUMA 节点的内存测试
3. **图形化界面**: 添加结果可视化
4. **网络测试**: 扩展为网络带宽测试
5. **存储测试**: 扩展为磁盘 I/O 测试 